<!doctype html>
<html>
	<head>
		<meta charset="utf-8"/>
		<script src="wasm_exec.js"></script>
		<script>
		</script>
	</head>
	<body>
        <div id="loading">Loading...</div>
        <a href="https://github.com/pointlander/ic" target=”_blank”>Source</a>
        <form id="form">
            <table>
                <tr>
                    <td>Count</td>
                    <td>Amount of text to generate</td>
                    <td><input type="text" id="count" name="count" value="1024"/></td>
                </tr>
                <tr>
                    <td>Query</td>
                    <td>Input query</td>
                    <td><input type="text" id="query" name="query"/></td>
                </tr>
            </table>
            <textarea id="text" name="text" rows="33" cols="80"></textarea><br/>
            <input type="submit"/>
        </form>
        <script type="text/javascript">
            const go = new Go();
			WebAssembly.instantiateStreaming(fetch("tree.wasm"), go.importObject).then((result) => {
				go.run(result.instance);
                load();
                document.getElementById("loading").hidden = true;
			});
            function submit(event) {
                event.preventDefault();
                query = document.getElementById('query').value;
                seed = Math.floor(Math.random() * 1000000);
                size = query.length;
                count = parseInt(document.getElementById('count').value);
                document.getElementById('text').value = inference(query, seed, size, count);
                return false;
            }
            function isSpace(character) {
                return /\s/.test(character);
            }
            var text = document.getElementById("text");
            function select(event) {
                let selectionStart = event.currentTarget.selectionStart;
                let value = text.value;
                let start = selectionStart;
                let end = selectionStart;
                while (start - 1 >= 0 && value[start - 1] != null && !isSpace(value[start - 1])) {
                    --start;
                }
                while (end + 1 < value.length && value[end + 1] != null && !isSpace(value[end + 1])) {
                    ++end;
                }
                const word = value.slice(start, end + 1);
                if (word == null) {
                    return false
                }
                document.getElementById('query').value = word
                query = word;
                seed = Math.floor(Math.random() * 1000000);
                size = query.length;
                count = parseInt(document.getElementById('count').value);
                document.getElementById('text').value = inference(query, seed, size, count);
                return true;
            }
            var form = document.getElementById("form");
            form.addEventListener('submit', submit); 
            text.addEventListener("click", select);
        </script>
    </body>
</html>